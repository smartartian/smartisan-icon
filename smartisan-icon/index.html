<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartisan Icons</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
      {
        "imports": {
          "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
      }
    </script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Smartisan Icons</h1>
            <div class="search-bar">
                <input 
                    type="text" 
                    v-model="searchKeyword" 
                    class="search-input" 
                    placeholder="搜索图标..."
                >
            </div>
        </header>

        <div class="container">
            <!-- 页面加载遮罩 -->
            <div v-if="loading" class="page-loader">
                <div class="loader-spinner"></div>
                <div class="loader-text">加载图标库...</div>
            </div>

            <div class="icon-grid" v-show="!loading">
                <div v-for="icon in paginatedIcons" :key="icon.filename" class="icon-card" :title="icon.displayName">
                    <div class="icon-image-wrapper" :class="{ loading: !icon.loaded }">
                        <img 
                            :src="icon.path" 
                            :alt="icon.displayName" 
                            :title="icon.displayName"
                            loading="lazy" 
                            :id="'img-' + icon.filename"
                            @load="handleImageLoad(icon)"
                            :class="{ loaded: icon.loaded }"
                        >
                    </div>
                    <div class="icon-name" :title="icon.displayName">{{ icon.displayName }}</div>
                    
                    <div class="icon-actions">
                        <button class="action-btn" @click="handleCopy(icon.path, '图片路径已复制')">复制路径</button>
                        <button class="action-btn" @click="handleCopy(icon.displayName, '图片名称已复制')">复制名称</button>
                        <button class="action-btn" @click="handleBase64(icon)">复制 Base64</button>
                    </div>
                </div>
                
                <div v-if="paginatedIcons.length === 0" style="text-align:center; grid-column: 1/-1; padding: 50px; color: #999;">
                    没有找到匹配的图标
                </div>
            </div>

            <!-- 分页 -->
            <div v-if="totalPages > 1" class="pagination">
                <button 
                    class="page-btn" 
                    :disabled="currentPage === 1"
                    @click="changePage(currentPage - 1)"
                >←</button>

                <template v-for="page in paginationRange" :key="page">
                    <button 
                        v-if="page !== '...'"
                        class="page-btn" 
                        :class="{ active: currentPage === page }"
                        @click="changePage(page)"
                    >{{ page }}</button>
                    <span v-else class="page-dots">...</span>
                </template>

                <button 
                    class="page-btn" 
                    :disabled="currentPage === totalPages"
                    @click="changePage(currentPage + 1)"
                >→</button>
            </div>
        </div>
    </div>

    <!-- 提示框容器 -->
    <div id="toast-container"></div>

    <!-- 加载 data.js，icons 会成为全局变量 -->
    <script src="data.js"></script>
    
    <script type="module">
        import { createApp, ref, computed, onMounted, watch, reactive } from 'vue'

        createApp({
            setup() {
                const searchKeyword = ref('')
                const currentPage = ref(1)
                const pageSize = 60
                const iconMap = ref({})
                const allIcons = ref([]) // 初始化为空，等待加载
                const loading = ref(true) // 页面级加载状态
                
                // 图片加载状态字典，使用 reactive 保证响应性
                const imageLoadStatus = reactive({})

                // 加载映射文件
                onMounted(() => {
                    // 模拟更自然的加载过程，或者等待 window.icons 就绪
                    // 这里假设 window.icons 已经由 data.js 加载
                    const rawIcons = window.icons || []
                    
                    fetch('app_icon_map.json')
                        .then(response => response.json())
                        .then(mapData => {
                            const map = {}
                            const orderedList = []
                            const stemToFilename = {}
                            const remainingFiles = new Set(rawIcons)

                            rawIcons.forEach(filename => {
                                const stem = filename.replace(/\.[^/.]+$/, "")
                                stemToFilename[stem] = filename
                            })

                            Object.entries(mapData).forEach(([displayName, filenames]) => {
                                const stems = Array.isArray(filenames) ? filenames : [filenames]
                                stems.forEach(stem => {
                                    map[stem] = displayName
                                    const filename = stemToFilename[stem]
                                    if (filename && remainingFiles.has(filename)) {
                                        orderedList.push(filename)
                                        remainingFiles.delete(filename)
                                    }
                                })
                            })

                            const remainingList = Array.from(remainingFiles).sort()
                            
                            iconMap.value = map
                            allIcons.value = [...orderedList, ...remainingList]
                            loading.value = false // 数据处理完毕，关闭页面遮罩
                        })
                        .catch(err => {
                            console.error('加载映射文件失败:', err)
                            // 即使映射失败，也要显示图标
                            allIcons.value = rawIcons
                            loading.value = false
                        })
                })

                // 搜索过滤
                const filteredIcons = computed(() => {
                    const keyword = searchKeyword.value.toLowerCase().trim()
                    if (!keyword) return allIcons.value

                    return allIcons.value.filter(filename => {
                        const fileStem = filename.replace(/\.[^/.]+$/, "")
                        const displayName = iconMap.value[fileStem] || filename
                        return filename.toLowerCase().includes(keyword) || 
                               displayName.toLowerCase().includes(keyword)
                    })
                })

                // 搜索时重置页码
                watch(searchKeyword, () => {
                    currentPage.value = 1
                })

                // 分页数据
                const paginatedIcons = computed(() => {
                    const start = (currentPage.value - 1) * pageSize
                    const end = start + pageSize
                    return filteredIcons.value.slice(start, end).map(filename => {
                        const fileStem = filename.replace(/\.[^/.]+$/, "")
                        const displayName = iconMap.value[fileStem] || filename
                        const path = `icon/${filename}`
                        
                        return {
                            filename,
                            displayName,
                            path,
                            loaded: !!imageLoadStatus[filename] // 获取加载状态
                        }
                    })
                })
                
                // 处理图片加载完成
                const handleImageLoad = (icon) => {
                    imageLoadStatus[icon.filename] = true
                }

                const totalPages = computed(() => Math.ceil(filteredIcons.value.length / pageSize))

                // 分页范围逻辑
                const paginationRange = computed(() => {
                    const total = totalPages.value
                    const current = currentPage.value
                    const range = 2
                    const res = []

                    for (let i = 1; i <= total; i++) {
                        if (i === 1 || i === total || (i >= current - range && i <= current + range)) {
                            res.push(i)
                        } else if (i === current - range - 1 || i === current + range + 1) {
                            res.push('...')
                        }
                    }
                    return res
                })

                // 方法
                const changePage = (page) => {
                    if (page >= 1 && page <= totalPages.value) {
                        currentPage.value = page
                        window.scrollTo({ top: 0, behavior: 'smooth' })
                    }
                }

                const handleCopy = (text, msg) => {
                    // 如果是相对路径，转换为绝对路径
                    if (text.startsWith && text.startsWith('icon/')) {
                         text = new URL(text, window.location.href).href
                    }
                    
                    navigator.clipboard.writeText(text).then(() => {
                        showToast(msg)
                    }).catch(err => {
                        console.error('复制失败:', err)
                        alert('复制失败，请重试')
                    })
                }

                const handleBase64 = (icon) => {
                    const img = document.getElementById('img-' + icon.filename)
                    if (img) {
                        convertImageToBase64(img, (base64) => {
                            if (base64) {
                                navigator.clipboard.writeText(base64).then(() => {
                                    showToast('Base64 已复制')
                                })
                            } else {
                                alert('Base64 转换失败')
                            }
                        })
                    }
                }

                const showToast = (msg) => {
                    const container = document.getElementById('toast-container')
                    const toast = document.createElement('div')
                    toast.style.position = 'fixed'
                    toast.style.top = '20px'
                    toast.style.left = '50%'
                    toast.style.transform = 'translateX(-50%)'
                    toast.style.background = 'rgba(0,0,0,0.8)'
                    toast.style.color = '#fff'
                    toast.style.padding = '10px 20px'
                    toast.style.borderRadius = '4px'
                    toast.style.zIndex = '1000'
                    toast.innerText = msg
                    container.appendChild(toast)
                    setTimeout(() => toast.remove(), 2000)
                }

                const convertImageToBase64 = (img, callback) => {
                    if (!img.complete) {
                        img.onload = () => convertImageToBase64(img, callback)
                        return
                    }
                    try {
                        const canvas = document.createElement('canvas')
                        canvas.width = img.naturalWidth
                        canvas.height = img.naturalHeight
                        const ctx = canvas.getContext('2d')
                        ctx.drawImage(img, 0, 0)
                        const dataURL = canvas.toDataURL('image/png')
                        callback(dataURL)
                    } catch (e) {
                        console.error('Base64 conversion failed', e)
                        fetch(img.src)
                            .then(response => response.blob())
                            .then(blob => {
                                const reader = new FileReader()
                                reader.onloadend = () => callback(reader.result)
                                reader.readAsDataURL(blob)
                            })
                            .catch(err => {
                                console.error('Fetch failed', err)
                                callback(null)
                            })
                    }
                }

                return {
                    searchKeyword,
                    paginatedIcons,
                    currentPage,
                    totalPages,
                    paginationRange,
                    changePage,
                    handleCopy,
                    handleBase64,
                    loading,
                    handleImageLoad
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
